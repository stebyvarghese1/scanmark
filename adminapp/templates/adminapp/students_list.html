{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Students List</title>
    <link rel="icon" href="{% static 'path/to/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'adminapp/dashboard.css' %}">
    <style>
        :root {
            --primary: #4e4499;
            --primary-dark: #5a4fcf;
            --accent: #00cec9;
            --light-bg: #fdfbff;
            --soft-border: #e0e0e0;
            --text-color: #2d3436;
            --hover-row: #f0f4ff;
        }

        body {
            background: var(--light-bg);
            font-family: 'Segoe UI', sans-serif;
            color: var(--text-color);
        }

        a {
            text-decoration: none;
        }

        .add-btn {
            float: right;
            margin-top: -30px;
            margin-right: 10px;
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.2);
            transition: background 0.1s, transform 0.1s;
        }

        .add-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        th, td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f1f1;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: #f9f9fb;
            font-weight: bold;
        }

        tr {
            transition: background 0.2s;
        }

        tr:hover {
            background: var(--hover-row);
        }

        .student-photo {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fafafa;
        }

        .student-detail-box, .modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0; top: 0;
            width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            overflow: auto;
        }

        .student-detail-content, .modal-content {
            background: #ffffffdd;
            margin: 40px auto;
            padding: 32px 32px 24px 32px;
            border-radius: 16px;
            width: 95vw;
            max-width: 700px;
            min-width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
            position: relative;
            border: 1px solid var(--soft-border);
            animation: fadeIn 0.25s ease-out;
        }

        @keyframes fadeIn {
            from { transform: scale(0.97); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .student-detail-content img {
            display: block;
            margin: 0 auto 18px auto;
            max-width: 180px;
            max-height: 180px;
            border-radius: 14px;
            border: 1px solid #ddd;
            background: #f8f8f8;
            object-fit: cover;
        }

        .photo-placeholder {
            display: block;
            margin: 0 auto 18px auto;
            width: 180px;
            height: 180px;
            border-radius: 14px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            color: #aaa;
            text-align: center;
            line-height: 180px;
            font-size: 1.1em;
        }

        .student-detail-content h3 {
            text-align: center;
            margin: 0 0 16px 0;
            font-size: 1.5em;
            color: var(--primary-dark);
        }

        .info-row {
            margin-bottom: 12px;
            font-size: 1em;
        }

        .info-label {
            font-weight: 600;
            color: #2d3436;
            width: 140px;
            display: inline-block;
        }

        .student-detail-actions {
            text-align: right;
            margin-top: 24px;
        }

        .student-detail-actions button {
            margin-left: 10px;
            padding: 9px 18px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #74b9ff;
            color: #fff;
        }

        .edit-btn:hover {
            background: #4a90e2;
        }

        .delete-btn {
            background: #ff7675;
            color: #fff;
        }

        .delete-btn:hover {
            background: #e74c3c;
        }

        .close-btn {
            background: #dfe6e9;
            color: #2d3436;
        }

        .close-btn:hover {
            background: #b2bec3;
        }

        .modal-close-x {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 24px;
            color: #888;
            cursor: pointer;
            font-weight: bold;
            z-index: 10;
            background: #fff;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            text-align: center;
            line-height: 34px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            transition: background 0.2s;
        }

        .modal-close-x:hover {
            background: #eee;
        }

        @media (max-width: 900px) {
            .student-detail-content, .modal-content {
                max-width: 96vw;
            }
        }

        @media (max-width: 600px) {
            .student-detail-content, .modal-content {
                width: 98vw;
                padding: 20px 12px;
            }

            .modal-close-x {
                right: 8px;
                top: 8px;
            }

            .info-label {
                display: block;
                margin-bottom: 4px;
            }
        }

        /* Modal Header */
        .modal-content h3 {
            margin-bottom: 20px;
            color: black;
            text-align: center;
            letter-spacing: 0.5px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Form Groups */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1 1 180px;
            min-width: 140px;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: black;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group textarea {
            padding: 8px 10px;
            border: 1.5px solid #d6d6f5;
            border-radius: 8px;
            font-size: 0.95em;
            background: #fff;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Textarea full width */
        textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
        }

        /* Modal Buttons */
        .modal-actions {
            margin-top: 24px;
            text-align: center;
        }

        .modal-actions button {
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 8px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cancel-btn {
            background: #fff;
            color: var(--primary);
            border: 1.5px solid var(--primary);
            margin-right: 10px;
        }

        .cancel-btn:hover {
            background: #f4f4fc;
        }

        .save-btn {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: #fff;
            border: none;
            box-shadow: 0 3px 10px rgba(108, 92, 231, 0.2);
        }

        .save-btn:hover {
            opacity: 0.95;
        }
        

    </style>

</head>
<body>
    <header>
        <h1>ScanMark Admin Dashboard</h1>
    </header>
    <nav>
        <ul>
            <li><a href="{% url 'students_list' %}">Students List</a></li>
            <li><a href="#">Attendance</a></li>
            <li><a href="#">Reports</a></li>
            <li><a href="{% url 'settings' %}">Settings</a></li>
        </ul>
    </nav>
    <main>
        <section>
            <h2 style="display:inline-block;">Students List</h2>
            <a href="#" class="add-btn" onclick="openAddStudentModal()">+ Add Student</a>
            <!-- Filter Form (update course options) -->
<form id="filterForm" style="margin: 18px 0 10px 0; display: flex; flex-wrap: wrap; gap: 18px; align-items: center;">
    <div>
        <label for="filter-batch-from">Batch From:</label>
        <input type="number" id="filter-batch-from" name="batch_from" min="1900" max="2100" style="width:90px;" value="{{ current_year }}">
    </div>
    <div>
        <label for="filter-batch-to">Batch To:</label>
        <input type="number" id="filter-batch-to" name="batch_to" min="1900" max="2100" style="width:90px;" value="{{ current_year }}">
    </div>
    <div>
        <label for="filter-course">Course:</label>
        <select id="filter-course" name="course">
            <option value="">All</option>
            {% for course in courses %}
                <option value="{{ course.id }}">{{ course.name }}</option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="save-btn" style="padding: 7px 18px;">Filter</button>
    <button type="button" class="cancel-btn" style="padding: 7px 18px;" onclick="resetFilters()">Reset</button>
</form>
            <!-- Student List Table -->
            <table id="students-table">
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Photo</th>
                        <th>Name</th>
                        <th>Register Number</th>
                    </tr>
                </thead>
                <tbody id="students-tbody">
                    {% for student in students|dictsort:"roll_number" %}
                    <tr data-student-id="{{ student.id }}" onclick="showStudentDetail('{{ student.id }}')" style="cursor:pointer;">
                        <td>{{ student.roll_number }}</td>
                        <td>
                            {% if student.photo %}
                                <img src="{{ student.photo.url }}" alt="Student Photo" class="student-photo">
                            {% else %}
                                <span class="photo-placeholder">No Photo</span>
                            {% endif %}
                        </td>
                        <td>{{ student.name }}</td>
                        <td>{{ student.register_number }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if students|length == 0 %}
                <p>No students found.</p>
            {% endif %}
        </section>
    </main>

    <!-- Student Detail Box -->
    <div id="studentDetailBox" class="student-detail-box" onclick="closeStudentDetailBox(event)">
        <div class="student-detail-content" id="studentDetailContent" onclick="event.stopPropagation()">
            <!-- Content will be filled by JS -->
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="modal" onclick="closeEditModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close-x" onclick="closeEditModal()">&times;</span>
            <h3>Edit Student</h3>
            <form id="editStudentForm" method="post" enctype="multipart/form-data" autocomplete="off">
                {% csrf_token %}
                <input type="hidden" id="edit-student-id" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-name">Name:</label>
                        <input type="text" id="edit-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-roll_number">Roll Number:</label>
                        <input type="text" id="edit-roll_number" name="roll_number" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-register_number">Register Number:</label>
                        <input type="text" id="edit-register_number" name="register_number" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-course">Course:</label>
                        <select id="edit-course" name="course" required>
                            <option value="">Select</option>
                            {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-batch_from">Batch From (Year):</label>
                        <input type="number" id="edit-batch_from" name="batch_from" min="1900" max="2100" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-batch_to">Batch To (Year):</label>
                        <input type="number" id="edit-batch_to" name="batch_to" min="1900" max="2100" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-date_of_birth">Date of Birth:</label>
                        <input type="date" id="edit-date_of_birth" name="date_of_birth" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-blood_group">Blood Group:</label>
                        <input type="text" id="edit-blood_group" name="blood_group" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-phone_number">Phone Number:</label>
                        <input type="text" id="edit-phone_number" name="phone_number" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-address">Address:</label>
                    <textarea id="edit-address" name="address" required></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-photo">Photo:</label>
                    <input type="file" id="edit-photo" name="photo" accept="image/*">
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="save-btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal" onclick="closeAddStudentModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close-x" onclick="closeAddStudentModal()">&times;</span>
            <h3>Add Student</h3>
            <form id="addStudentForm" method="post" enctype="multipart/form-data" action="{% url 'add_student' %}" autocomplete="off">
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group">
                        <label for="add-name">Name:</label>
                        <input type="text" id="add-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="add-roll_number">Roll Number:</label>
                        <input type="text" id="add-roll_number" name="roll_number" required>
                    </div>
                    <div class="form-group">
                        <label for="add-register_number">Register Number:</label>
                        <input type="text" id="add-register_number" name="register_number" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="add-course">Course:</label>
                        <select id="add-course" name="course" required>
                            <option value="">Select</option>
                            {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="add-batch_from">Batch From (Year):</label>
                        <input type="number" id="add-batch_from" name="batch_from" min="1900" max="2100" required>
                    </div>
                    <div class="form-group">
                        <label for="add-batch_to">Batch To (Year):</label>
                        <input type="number" id="add-batch_to" name="batch_to" min="1900" max="2100" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="add-date_of_birth">Date of Birth:</label>
                        <input type="date" id="add-date_of_birth" name="date_of_birth" required>
                    </div>
                    <div class="form-group">
                        <label for="add-blood_group">Blood Group:</label>
                        <input type="text" id="add-blood_group" name="blood_group" required>
                    </div>
                    <div class="form-group">
                        <label for="add-phone_number">Phone Number:</label>
                        <input type="text" id="add-phone_number" name="phone_number" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="add-address">Address:</label>
                    <textarea id="add-address" name="address" required></textarea>
                </div>
                <div class="form-group">
                    <label for="add-photo">Photo:</label>
                    <input type="file" id="add-photo" name="photo" accept="image/*" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeAddStudentModal()">Cancel</button>
                    <button type="submit" class="save-btn">Save</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Show student detail box
        function showStudentDetail(studentId) {
            fetch(`/students/${studentId}/?detail=1`, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(response => response.json())
            .then(student => {
                let photoHtml = student.photo
                    ? `<img src="${student.photo}" alt="Student Photo">`
                    : `<span class="photo-placeholder">No Photo</span>`;
                let batch = (student.batch_from && student.batch_to) ? `${student.batch_from} - ${student.batch_to}` : (student.batch || '');
                let formattedAddress = (student.address || '').replace(/\n/g, '<br>');
                let html = `
                    <span class="modal-close-x" onclick="closeStudentDetailBox()">&times;</span>
                    ${photoHtml}
                    <h3>${student.name}</h3>
                    <div class="info-row"><span class="info-label">Register Number:</span> ${student.register_number || ''}</div>
                    <div class="info-row"><span class="info-label">Roll Number:</span> ${student.roll_number || ''}</div>
                    <div class="info-row"><span class="info-label">Course:</span> ${student.course || ''}</div>
                    <div class="info-row"><span class="info-label">Batch:</span> ${(student.batch_from && student.batch_to) ? `${student.batch_from} - ${student.batch_to}` : ''}</div>
                    <div class="info-row"><span class="info-label">Date of Birth:</span> ${student.date_of_birth || ''}</div>
                    <div class="info-row"><span class="info-label">Blood Group:</span> ${student.blood_group || ''}</div>
                    <div class="info-row"><span class="info-label">Address:</span> <div style="display:inline-block;vertical-align:top;max-width:350px;white-space:pre-line;">${formattedAddress}</div></div>
                    <div class="info-row"><span class="info-label">Phone Number:</span> ${student.phone_number || ''}</div>
                    <div class="student-detail-actions">
                        <button class="edit-btn" onclick="openEditModal(${student.id})">Edit</button>
                        <button class="delete-btn" onclick="deleteStudent(${student.id})">Delete</button>
                        <button class="close-btn" onclick="closeStudentDetailBox()">Close</button>
                    </div>
                `;
                document.getElementById('studentDetailContent').innerHTML = html;
                document.getElementById('studentDetailBox').style.display = 'block';
            });
        }
        function closeStudentDetailBox(event) {
            if (!event || event.target === document.getElementById('studentDetailBox')) {
                document.getElementById('studentDetailBox').style.display = 'none';
            }
        }
        function openEditModal(studentId) {
            fetch(`/students/${studentId}/?detail=1`, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(response => response.json())
            .then(student => {
                document.getElementById('edit-student-id').value = student.id;
                document.getElementById('edit-name').value = student.name || '';
                document.getElementById('edit-roll_number').value = student.roll_number || '';
                document.getElementById('edit-register_number').value = student.register_number || '';
                document.getElementById('edit-course').value = student.course_id || '';
                document.getElementById('edit-batch_from').value = student.batch_from || '';
                document.getElementById('edit-batch_to').value = student.batch_to || '';
                document.getElementById('edit-date_of_birth').value = student.date_of_birth || '';
                document.getElementById('edit-blood_group').value = student.blood_group || '';
                document.getElementById('edit-address').value = student.address || '';
                document.getElementById('edit-phone_number').value = student.phone_number || '';
                document.getElementById('editStudentModal').style.display = 'block';
            });
        }
        function closeEditModal(event) {
            if (!event || event.target === document.getElementById('editStudentModal')) {
                document.getElementById('editStudentModal').style.display = 'none';
                document.getElementById('editStudentForm').reset();
            }
        }
        function openAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'block';
        }
        function closeAddStudentModal(event) {
            if (!event || event.target === document.getElementById('addStudentModal')) {
                document.getElementById('addStudentModal').style.display = 'none';
                document.getElementById('addStudentForm').reset();
            }
        }
        function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                fetch(`/students/${id}/delete/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.message) {
                        location.reload();
                    } else {
                        alert('Error: ' + (result.error || 'Could not delete student.'));
                    }
                });
            }
        }

        // Add Student form submit
        document.getElementById('addStudentForm').onsubmit = function(e) {
            e.preventDefault();
            var form = e.target;
            var data = new FormData(form);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: data
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || "Could not add student.");
                }
            });
        };

        // Edit Student form submit
        document.getElementById('editStudentForm').onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('edit-student-id').value;
            const form = e.target;
            const data = new FormData(form);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/students/${id}/edit/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: data
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || "Could not update student.");
                }
            });
        };

        document.getElementById('filterForm').onsubmit = function(e) {
            e.preventDefault();
            const batch_from = document.getElementById('filter-batch-from').value;
            const batch_to = document.getElementById('filter-batch-to').value;
            const course = document.getElementById('filter-course').value;

            fetch(`/students/?batch_from=${batch_from}&batch_to=${batch_to}&course=${course}`, {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('students-tbody');
                tbody.innerHTML = '';
                data.students.forEach(student => {
                    let photoHtml = student.photo
                        ? `<img src="${student.photo}" alt="Student Photo" class="student-photo">`
                        : `<span class="photo-placeholder">No Photo</span>`;
                    tbody.innerHTML += `
                        <tr data-student-id="${student.id}" onclick="showStudentDetail('${student.id}')" style="cursor:pointer;">
                            <td>${student.roll_number || ''}</td>
                            <td>${photoHtml}</td>
                            <td>${student.name || ''}</td>
                            <td>${student.register_number || ''}</td>
                        </tr>
                    `;
                });
            });
        };

        function resetFilters() {
            document.getElementById('filter-batch-from').value = '';
            document.getElementById('filter-batch-to').value = '';
            document.getElementById('filter-course').value = '';
            document.getElementById('filterForm').dispatchEvent(new Event('submit'));
        }
    </script>
</body>
</html>